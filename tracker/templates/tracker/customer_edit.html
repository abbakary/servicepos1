{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Edit Customer{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Edit Customer</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:customers_list' %}">Customers</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:customer_detail' customer.pk %}">{{ customer.full_name }}</a></li>
          <li class="breadcrumb-item active">Edit</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="card">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ form.full_name.label }}</label>
            {{ form.full_name }}
            {% if form.full_name.errors %}<div class="text-danger f-12">{{ form.full_name.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label">{{ form.phone.label }}</label>
            {{ form.phone }}
            {% if form.phone.errors %}<div class="text-danger f-12">{{ form.phone.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label">{{ form.whatsapp.label }}</label>
            {{ form.whatsapp }}
            {% if form.whatsapp.errors %}<div class="text-danger f-12">{{ form.whatsapp.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.email.label }}</label>
            {{ form.email }}
            {% if form.email.errors %}<div class="text-danger f-12">{{ form.email.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-8">
            <label class="form-label">{{ form.address.label }}</label>
            {{ form.address }}
            {% if form.address.errors %}<div class="text-danger f-12">{{ form.address.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">{{ form.customer_type.label }}</label>
            {{ form.customer_type }}
            {% if form.customer_type.errors %}<div class="text-danger f-12">{{ form.customer_type.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-4" id="organization-name-field">
            <label class="form-label">{{ form.organization_name.label }}</label>
            {{ form.organization_name }}
            {% if form.organization_name.errors %}<div class="text-danger f-12">{{ form.organization_name.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-4" id="tax-number-field">
            <label class="form-label">{{ form.tax_number.label }}</label>
            {{ form.tax_number }}
            {% if form.tax_number.errors %}<div class="text-danger f-12">{{ form.tax_number.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-md-4" id="personal-subtype-field">
            <label class="form-label">{{ form.personal_subtype.label }}</label>
            {{ form.personal_subtype }}
            {% if form.personal_subtype.errors %}<div class="text-danger f-12">{{ form.personal_subtype.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12">
            <label class="form-label">{{ form.notes.label }}</label>
            {{ form.notes }}
            {% if form.notes.errors %}<div class="text-danger f-12">{{ form.notes.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <a class="btn btn-light" href="{% url 'tracker:customer_detail' customer.pk %}">Cancel</a>
          <button class="btn btn-success" type="submit">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    var typeEl = document.getElementById('{{ form.customer_type.id_for_label }}') || document.querySelector('[name="{{ form.customer_type.html_name }}"]');
    var orgField = document.getElementById('organization-name-field');
    var taxField = document.getElementById('tax-number-field');
    var personalField = document.getElementById('personal-subtype-field');
    function toggleCustomerFields(){
      var t = (typeEl && (typeEl.value || (typeEl.options && typeEl.options[typeEl.selectedIndex] && typeEl.options[typeEl.selectedIndex].value))) || '';
      var isOrg = (t==='government' || t==='ngo' || t==='company');
      if(orgField){ orgField.style.display = isOrg ? 'block' : 'none'; }
      if(taxField){ taxField.style.display = isOrg ? 'block' : 'none'; }
      if(personalField){ personalField.style.display = (t==='personal') ? 'block' : 'none'; }
    }
    if(typeEl){ typeEl.addEventListener('change', toggleCustomerFields); toggleCustomerFields(); }
  });
</script>
{% endblock %}
{% endblock %}
