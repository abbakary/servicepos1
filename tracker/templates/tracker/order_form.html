{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Edit Order{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6"><h4>Edit Order</h4></div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}">Orders</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tracker:order_detail' order.pk %}">#{{ order.order_number }}</a></li>
            <li class="breadcrumb-item active">Edit</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">Customer Information</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <i class="fa fa-user text-primary me-2"></i>
              <strong>{{ customer.full_name }}</strong>
            </div>
            <div class="d-flex align-items-center mb-2">
              <i class="fa fa-phone text-success me-2"></i>
              <span>{{ customer.phone }}</span>
            </div>
            {% if customer.email %}
              <div class="d-flex align-items-center mb-2">
                <i class="fa fa-envelope text-info me-2"></i>
                <span>{{ customer.email }}</span>
              </div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <i class="fa fa-tag text-secondary me-2"></i>
              <span class="badge bg-secondary">{{ customer.get_customer_type_display|default:"Personal" }}</span>
            </div>
            {% if customer.organization_name %}
              <div class="d-flex align-items-center mb-2">
                <i class="fa fa-building text-primary me-2"></i>
                <span>{{ customer.organization_name }}</span>
              </div>
            {% endif %}
            {% if customer.personal_subtype %}
              <div class="d-flex align-items-center mb-2">
                <i class="fa fa-user-tag text-info me-2"></i>
                <span>{{ customer.get_personal_subtype_display }}</span>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="mt-2">
          <a href="{% url 'tracker:customer_detail' customer.pk %}" class="btn btn-sm btn-outline-primary">
            <i class="fa fa-eye me-1"></i>View Details
          </a>
          <a href="{% url 'tracker:order_detail' order.pk %}" class="btn btn-sm btn-outline-secondary">
            <i class="fa fa-arrow-left me-1"></i>Back to Order
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="card">
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ form.type.label }}</label>
              {{ form.type }}
              {% if form.type.errors %}<div class="text-danger f-12">{{ form.type.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ form.priority.label }}</label>
              {{ form.priority }}
              {% if form.priority.errors %}<div class="text-danger f-12">{{ form.priority.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4" id="vehicleFieldGroup">
              <label class="form-label">{{ form.vehicle.label }}</label>
              {{ form.vehicle }}
              {% if form.vehicle.errors %}<div class="text-danger f-12">{{ form.vehicle.errors|striptags }}</div>{% endif %}
              <small class="text-muted">Vehicle can be reassigned if needed.</small>
            </div>
          </div>

          {% include 'tracker/partials/order_form_sections.html' with form=form %}

          <div class="d-flex gap-2 mt-4">
            <a class="btn btn-light" href="{% url 'tracker:order_detail' order.pk %}">Cancel</a>
            <button class="btn btn-success" type="submit">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% block extra_js %}
  <script>
    (function(){
      var typeEl = document.getElementById('{{ form.type.id_for_label }}') || document.querySelector('[name="{{ form.type.html_name }}"]');
      function updateSections(){
        var t = (typeEl && (typeEl.value || (typeEl.options && typeEl.options[typeEl.selectedIndex] && typeEl.options[typeEl.selectedIndex].value))) || '';
        var svc = document.getElementById('section-service');
        var sal = document.getElementById('section-sales');
        var inq = document.getElementById('section-inquiry');
        if (svc) svc.style.display = (t==='service')? 'block':'none';
        if (sal) sal.style.display = (t==='sales')? 'block':'none';
        if (inq) inq.style.display = (t==='inquiry')? 'block':'none';
        var veh = document.getElementById('vehicleFieldGroup');
        if (veh) veh.style.display = (t==='inquiry')? 'none':'block';
      }
      if(typeEl){ typeEl.addEventListener('change', updateSections); updateSections(); }

      (function(){
        var itemEl = document.getElementById('id_item_name');
        var brandEl = document.getElementById('id_brand');
        if (!itemEl || !brandEl) return;
        var mapping = {};
        try { mapping = JSON.parse(itemEl.getAttribute('data-items') || '{}'); } catch(e) { mapping = {}; }
        itemEl.addEventListener('change', function(){
          var meta = mapping[this.value];
          if (!meta) return;
          brandEl.value = meta.brand || '';
        });
      })();
    })();
  </script>
  {% endblock %}
{% endblock %}