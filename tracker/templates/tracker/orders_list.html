{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Orders</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item active">Orders</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Enhanced KPI Cards Section -->
  <div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Total Orders</h6>
              <h3 class="mb-0 fw-bold">{{ total_orders }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-shopping-bag fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">All orders in the system</small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-warning text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Active Orders</h6>
              <h3 class="mb-0 fw-bold">{{ active_orders }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-clock fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Currently in progress</small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Completed Today</h6>
              <h3 class="mb-0 fw-bold">{{ completed_today }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-check-circle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Finished in last 24 hours</small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Overdue</h6>
              <h3 class="mb-0 fw-bold">{{ overdue_count|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-exclamation-triangle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Past their due date</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filters Section -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-filter me-2"></i>Search & Filters</h6>
        </div>
        <div class="card-body">
          <form method="get">
            <div class="row g-3 align-items-end">
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Status</label>
                <select name="status" class="form-select">
                  {% with s=status %}
                  <option value="all" {% if s == 'all' %}selected{% endif %}>All</option>
                  <option value="created" {% if s == 'created' %}selected{% endif %}>New</option>
                  <option value="in_progress" {% if s == 'in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="overdue" {% if s == 'overdue' %}selected{% endif %}>Overdue</option>
                  <option value="completed" {% if s == 'completed' %}selected{% endif %}>Completed</option>
                  <option value="cancelled" {% if s == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  {% endwith %}
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Type</label>
                <select name="type" class="form-select">
                  {% with t=type %}
                  <option value="all" {% if t == 'all' %}selected{% endif %}>All</option>
                  <option value="service" {% if t == 'service' %}selected{% endif %}>Service</option>
                  <option value="sales" {% if t == 'sales' %}selected{% endif %}>Sales</option>
                  <option value="inquiry" {% if t == 'inquiry' %}selected{% endif %}>Inquiry</option>
                  {% endwith %}
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Priority</label>
                <select name="priority" class="form-select">
                  <option value="">Any</option>
                  <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                  <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                  <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                  <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Date Range</label>
                <select name="date_range" class="form-select">
                  {% with dr=request.GET.date_range|default:'' %}
                  <option value="">Any</option>
                  <option value="daily" {% if dr == 'daily' or dr == 'today' %}selected{% endif %}>Today</option>
                  <option value="weekly" {% if dr == 'weekly' or dr == 'week' %}selected{% endif %}>Last 7 days</option>
                  <option value="monthly" {% if dr == 'monthly' or dr == 'month' %}selected{% endif %}>Last 30 days</option>
                  <option value="yearly" {% if dr == 'yearly' or dr == 'year' %}selected{% endif %}>This year</option>
                  {% endwith %}
                </select>
              </div>
              {% if user.is_superuser %}
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Branch (admin)</label>
                <input type="text" name="branch" value="{{ request.GET.branch }}" class="form-control" placeholder="Branch name" list="branchesList">
                {% include 'tracker/partials/branch_datalist.html' %}
              </div>
              {% endif %}
              <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="d-flex gap-2 h-100 pt-3">
                  <button class="btn btn-primary flex-fill" type="submit">
                    <i class="fa fa-filter me-1"></i> Filter
                  </button>
                  {% if request.GET.status or request.GET.type or request.GET.priority or request.GET.date_range or request.GET.branch %}
                  <a href="{% url 'tracker:orders_list' %}" class="btn btn-outline-secondary" title="Clear Filters">
                    <i class="fa fa-times"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0"><i class="fa fa-list me-2"></i>Orders List</h5>
      <a href="{% url 'tracker:order_start' %}" class="btn btn-primary btn-sm">
        <i class="fa fa-plus me-1"></i> New Order
      </a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="fw-semibold">Order #</th>
              <th class="fw-semibold">Customer</th>
              <th class="fw-semibold">Type</th>
              <th class="fw-semibold">Status</th>
              <th class="fw-semibold">Priority</th>
              <th class="fw-semibold">Created</th>
              <th class="fw-semibold">Time</th>
              <th class="fw-semibold text-end" style="width: 60px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr>
              <td>
                <a href="{% url 'tracker:order_detail' pk=o.id %}" class="text-decoration-none fw-medium">
                  {{ o.order_number }}
                </a>
              </td>
              <td>
                <a href="{% url 'tracker:customer_detail' pk=o.customer.id %}" class="text-decoration-none">
                  {{ o.customer.full_name }}
                </a>
              </td>
              <td>
                {% if o.type == 'service' %}
                  <span class="badge bg-primary rounded-pill"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif o.type == 'sales' %}
                  <span class="badge bg-success rounded-pill"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% elif o.type == 'inquiry' %}
                  <span class="badge bg-info rounded-pill"><i class="fa fa-question-circle me-1"></i>Inquiry</span>
                {% else %}
                  <span class="badge bg-secondary rounded-pill">{{ o.type }}</span>
                {% endif %}
              </td>
              <td>
                {% if o.status == 'created' %}
                  <span class="badge bg-secondary rounded-pill"><i class="fa fa-play me-1"></i>New</span>
                {% elif o.status == 'in_progress' %}
                  <span class="badge bg-warning text-dark rounded-pill"><i class="fa fa-clock me-1"></i>In Progress</span>
                {% elif o.status == 'overdue' %}
                  <span class="badge bg-danger rounded-pill"><i class="fa fa-exclamation-triangle me-1"></i>Overdue</span>
                {% elif o.status == 'completed' %}
                  <div class="d-flex flex-column">
                    <span class="badge bg-success rounded-pill mb-1"><i class="fa fa-check me-1"></i>Completed</span>
                    <div class="small">
                      {% if o.estimated_duration and o.actual_duration %}
                        <span class="badge {{ o|eta_status_badge }}">{{ o|eta_status_label }}</span>
                        <span class="text-muted ms-1">Actual: {{ o.actual_duration|format_minutes }}</span>
                      {% elif o.actual_duration %}
                        <span class="text-muted">Actual: {{ o.actual_duration|format_minutes }}</span>
                      {% endif %}
                    </div>
                  </div>
                {% elif o.status == 'cancelled' %}
                  <span class="badge bg-dark rounded-pill"><i class="fa fa-times me-1"></i>Cancelled</span>
                {% else %}
                  <span class="badge bg-light text-dark rounded-pill">{{ o.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if o.priority == 'low' %}
                  <span class="badge bg-success rounded-pill"><i class="fa fa-arrow-down me-1"></i>Low</span>
                {% elif o.priority == 'medium' %}
                  <span class="badge bg-warning text-dark rounded-pill"><i class="fa fa-minus me-1"></i>Medium</span>
                {% elif o.priority == 'high' %}
                  <span class="badge bg-orange text-white rounded-pill"><i class="fa fa-arrow-up me-1"></i>High</span>
                {% elif o.priority == 'urgent' %}
                  <span class="badge bg-danger rounded-pill"><i class="fa fa-fire me-1"></i>Urgent</span>
                {% else %}
                  <span class="badge bg-secondary rounded-pill">{{ o.priority }}</span>
                {% endif %}
              </td>
              <td class="text-muted small">{{ o.created_at|localtime|date_medium }}</td>
              <td>
                {% if o.estimated_duration %}
                  <div class="d-flex flex-column">
                    {% with lbl=o|eta_status_label %}
                      <span class="badge {{ o|eta_status_badge }}">{{ lbl|default:'No estimate' }}</span>
                    {% endwith %}
                    <small class="text-muted mt-1">
                      {% if o.status == 'completed' and o.actual_duration %}
                        Est: {{ o.estimated_duration|format_minutes }} • Actual: {{ o.actual_duration|format_minutes }}
                      {% else %}
                        Est: {{ o.estimated_duration|format_minutes }}{% if o.status != 'completed' %} • Elapsed: {{ o|elapsed_minutes|format_minutes }}{% endif %}
                      {% endif %}
                    </small>
                  </div>
                {% else %}
                  <span class="badge bg-secondary">No estimate</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="dropdown actions-dropdown">
                  <button class="btn btn-action" type="button" data-bs-toggle="dropdown" aria-label="More actions">
                    <i class="fa fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:order_detail' pk=o.id %}">
                        <i class="fa fa-eye me-2 text-primary"></i>View Details
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:order_edit' pk=o.id %}">
                        <i class="fa fa-edit me-2 text-success"></i>Edit Order
                      </a>
                    </li>
                    <li><hr class="dropdown-divider my-1"></li>
                    <li>
                      <form method="post" action="{% url 'tracker:order_delete' pk=o.id %}"
                            onsubmit="return confirm('Are you sure you want to delete this order?');">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'tracker:orders_list' %}">
                        <button type="submit" class="dropdown-item text-danger">
                          <i class="fa fa-trash me-2"></i>Delete Order
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <div class="d-flex flex-column align-items-center">
                  <i class="fa fa-inbox fa-2x mb-2 text-muted"></i>
                  <span class="mb-2">No orders found</span>
                  {% if request.GET.status or request.GET.type or request.GET.priority or request.GET.date_range %}
                  <a href="{% url 'tracker:orders_list' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fa fa-times me-1"></i>Clear Filters
                  </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer bg-light border-top-0">
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted">
            <i class="fa fa-info-circle me-1"></i>
            Showing {{ orders.start_index }}-{{ orders.end_index }} of {{ orders.paginator.count }} orders
          </div>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              {% if orders.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1" title="First page">
                  <i class="fa fa-angle-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.previous_page_number }}" title="Previous page">
                  <i class="fa fa-angle-left"></i> Prev
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-double-left"></i></span>
              </li>
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-left"></i> Prev</span>
              </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">{{ orders.number }}</span>
              </li>
              
              {% if orders.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.next_page_number }}" title="Next page">
                  Next <i class="fa fa-angle-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.paginator.num_pages }}" title="Last page">
                  <i class="fa fa-angle-double-right"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next <i class="fa fa-angle-right"></i></span>
              </li>
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-double-right"></i></span>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Complete order functionality
  document.querySelectorAll('.js-complete-order').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = this.dataset.orderId;
      if (confirm('Are you sure you want to mark this order as completed?')) {
        // Add your complete order logic here
        console.log('Completing order:', orderId);
        // You might want to submit a form or make an AJAX request here
      }
    });
  });

  // Cancel order functionality
  document.querySelectorAll('.js-cancel-order').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = this.dataset.orderId;
      if (confirm('Are you sure you want to cancel this order?')) {
        // Add your cancel order logic here
        console.log('Cancelling order:', orderId);
        // You might want to submit a form or make an AJAX request here
      }
    });
  });

  // Keep dropdown open when clicking inside form elements
  document.querySelectorAll('.actions-dropdown .dropdown-menu form').forEach(form => {
    form.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });
});
</script>
{% endblock %}

<style>
/* Enhanced KPI Cards */
.kpi-card {
  border: none;
  border-radius: 12px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.kpi-icon {
  opacity: 0.8;
}

/* Enhanced Priority Badges */
.bg-orange {
  background-color: #ff6b35 !important;
}

/* Clean Action Button - No Dropdown Arrow */
.btn-action {
    width: 32px !important;
    height: 28px !important;
    padding: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 6px !important;
    border: 1px solid #dee2e6 !important;
    background: white !important;
    color: #6c757d !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
}

.btn-action::after {
    display: none !important;
}

.btn-action:hover {
    background: #f8f9fa !important;
    border-color: #6c757d !important;
    color: #495057 !important;
    transform: scale(1.05);
}

.btn-action:focus {
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25) !important;
}

/* Fixed Dropdown Styles */
.actions-dropdown .dropdown-menu {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 180px;
    padding: 0.5rem;
}

.actions-dropdown .dropdown-item {
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    margin: 0.125rem 0;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    font-size: 0.85rem;
}

.actions-dropdown .dropdown-item:hover {
    transform: translateX(2px);
    text-decoration: none;
}

.actions-dropdown .dropdown-item:hover i.text-primary,
.actions-dropdown .dropdown-item:hover {
    background-color: #0d6efd;
    color: white !important;
}

.actions-dropdown .dropdown-item:hover i.text-success {
    background-color: #198754;
    color: white !important;
}

.actions-dropdown .dropdown-item:hover i.text-warning {
    background-color: #ffc107;
    color: black !important;
}

.actions-dropdown .dropdown-item:hover i.text-danger {
    background-color: #dc3545;
    color: white !important;
}

/* Ensure dropdown stays open when interacting with form */
.actions-dropdown .dropdown-menu form {
    margin: 0;
}

.actions-dropdown .dropdown-menu form .dropdown-item {
    margin: 0;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.actions-dropdown .dropdown-menu form .dropdown-item:focus {
    outline: none;
    box-shadow: none;
}

/* Improved table responsiveness */
.table-responsive {
    border-radius: 8px;
}

/* Enhanced pagination */
.pagination .page-link {
    border-radius: 6px;
    margin: 0 2px;
}

/* Card header improvements */
.card-header {
    border-radius: 8px 8px 0 0 !important;
}

/* Full width search section */
.card-body .row {
    width: 100%;
    margin: 0;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .kpi-card .card-body {
        padding: 1rem;
    }
    
    .kpi-icon {
        display: none;
    }
    
    .actions-dropdown .dropdown-menu {
        min-width: 160px;
    }
    
    .btn-action {
        width: 28px !important;
        height: 26px !important;
        font-size: 12px !important;
    }
}

/* Better spacing for empty states */
.table td.text-center {
    padding: 3rem 1rem;
}

/* Ensure full width for search section */
.row.mb-3 .col-12 {
    padding-left: 0;
    padding-right: 0;
}

/* Table action column fixed width */
th.text-end[style*="width: 60px"],
td.text-end:last-child {
    width: 60px;
    min-width: 60px;
    max-width: 60px;
}

/* Remove any dropdown toggle arrows globally */
.dropdown-toggle::after {
    display: none !important;
}

/* Improved Search & Filter Section */
.card .card-body .form-control:focus,
.card .card-body .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
