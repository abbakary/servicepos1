{%load static%}
<form id="customerRegistrationForm" method="post" novalidate>
  {% csrf_token %}
  <input type="hidden" name="step" id="currentStep" value="{{ step }}">
  <input type="hidden" name="save_only" id="saveOnly" value="0">
  <input type="hidden" id="registrationIntent" value="{{ intent }}">

  <div class="wizard-step">
    {% if step == 1 %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Full name</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}<div class="text-danger f-12">{{ form.full_name.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Phone</label>
          <div class="tz-phone-group customer-phone-group">
            <span class="tz-flag-addon">
              <img src="{% static 'assets/images/flags/tz.svg' %}" alt="Tanzania flag" class="customer-phone-flag">
            </span>
            {{ form.phone }}
          </div>
          {% if form.phone.errors %}<div class="text-danger f-12">{{ form.phone.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Email (optional)</label>
          {{ form.email }}
          {% if form.email.errors %}<div class="text-danger f-12">{{ form.email.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Customer type</label>
          {{ form.customer_type }}
          {% if form.customer_type.errors %}<div class="text-danger f-12">{{ form.customer_type.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-12" id="organization-field" style="display: none;">
          <label class="form-label">Organization name</label>
          {{ form.organization_name }}
          {% if form.organization_name.errors %}<div class="text-danger f-12">{{ form.organization_name.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-md-6" id="tax-field" style="display: none;">
          <label class="form-label">Tax number</label>
          {{ form.tax_number }}
          {% if form.tax_number.errors %}<div class="text-danger f-12">{{ form.tax_number.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-md-6" id="personal-subtype-field" style="display: none;">
          <label class="form-label">Personal subtype</label>
          {{ form.personal_subtype }}
          {% if form.personal_subtype.errors %}<div class="text-danger f-12">{{ form.personal_subtype.errors|striptags }}</div>{% endif %}
        </div>
        <div class="col-12">
          <label class="form-label">Address (optional)</label>
          {{ form.address }}
        </div>
        <div class="col-12">
          <label class="form-label">Notes (optional)</label>
          {{ form.notes }}
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <a class="btn btn-light" href="{% url 'tracker:customers_list' %}">Cancel</a>
        <button type="button" class="btn btn-outline-primary" id="saveCustomerBtn">Save Customer</button>
        <button type="button" class="btn btn-primary ms-auto" id="nextStepBtn">Next</button>
      </div>

    {% elif step == 2 %}
      <div class="row">
        <div class="col-12 mb-3">
          <h6 class="mb-2">What brings the customer today?</h6>
        </div>
        <div class="col-md-4">
          <div class="card intent-card p-3 cursor-pointer" onclick="selectIntent('service')">
            <div class="card-body">
              <h6>Service</h6>
              <p class="mb-0 small text-muted">I need a service</p>
              <input type="radio" name="intent" value="service" class="d-none" {% if step2.intent == 'service' %}checked{% endif %}>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card intent-card p-3 cursor-pointer" onclick="selectIntent('sales')">
            <div class="card-body">
              <h6>Purchase</h6>
              <p class="mb-0 small text-muted">I want to buy something</p>
              <input type="radio" name="intent" value="sales" class="d-none" {% if step2.intent == 'sales' %}checked{% endif %}>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card intent-card p-3 cursor-pointer" onclick="selectIntent('inquiry')">
            <div class="card-body">
              <h6>Inquiry</h6>
              <p class="mb-0 small text-muted">Just an inquiry</p>
              <input type="radio" name="intent" value="inquiry" class="d-none" {% if step2.intent == 'inquiry' %}checked{% endif %}>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button type="button" class="btn btn-light" id="backFromStep2">Back</button>
        <button type="button" class="btn btn-primary ms-auto" id="nextStep2">Next</button>
      </div>

    {% elif step == 3 %}
      {# Intent-specific detailed form: service, sales, or inquiry #}
      <input type="hidden" name="service_type" id="id_service_type" value="{% if intent == 'sales' %}tire_sales{% elif intent == 'service' %}car_service{% else %}{{ step3.service_type }}{% endif %}">

      {% if intent == 'service' %}
        <div class="row g-3">
          <!-- Vehicle Information (optional) -->
          <div class="col-12">
            <div class="card">
              <div class="card-header"><h6 class="mb-0">Vehicle Information </h6></div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">Plate Number</label>
                    <input name="plate_number" id="id_plate_number" class="form-control" placeholder="e.g., T123ABC">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Make</label>
                    <input name="make" id="id_make" class="form-control" placeholder="e.g., Toyota">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Model</label>
                    <input name="model" id="id_model" class="form-control" placeholder="e.g., Corolla">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Vehicle Type</label>
                    <select name="vehicle_type" id="id_vehicle_type" class="form-select">
                      <option value="">Select type</option>
                      <option value="sedan">Sedan</option>
                      <option value="suv">SUV</option>
                      <option value="truck">Truck</option>
                      <option value="motorcycle">Motorcycle</option>
                      <option value="bus">Bus</option>
                      <option value="van">Van</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Service Offered -->
          <div class="col-12">
            <div class="card border-success">
              <div class="card-header bg-success text-white"><h6 class="mb-0">Service Offered</h6></div>
              <div class="card-body">
                <div class="row g-3">
                  {% if service_types %}
                    {% for svc in service_types %}
                    <div class="col-md-4 mb-2">
                      <input type="checkbox" id="svc_{{ forloop.counter }}" name="service_selection" value="{{ svc.name }}" class="visually-hidden service-checkbox" data-minutes="{{ svc.estimated_minutes }}">
                      <label for="svc_{{ forloop.counter }}" class="card service-offer p-3 cursor-pointer w-100" style="border:1px solid #e9ecef;">
                        <div class="d-block">{{ svc.name }} <small class="text-muted">({{ svc.estimated_minutes }} mins)</small></div>
                      </label>
                    </div>
                    {% endfor %}
                  {% else %}
                    {% for svc in service_offers %}
                    <div class="col-md-4 mb-2">
                      <input type="checkbox" id="svc_fallback_{{ forloop.counter }}" name="service_selection" value="{{ svc }}" class="visually-hidden">
                      <label for="svc_fallback_{{ forloop.counter }}" class="card service-offer p-3 cursor-pointer w-100" style="border:1px solid #e9ecef;">
                        <div class="d-block">{{ svc }}</div>
                      </label>
                    </div>
                    {% endfor %}
                  {% endif %}
                </div>
                <div class="small text-muted mt-2" id="cr_total_eta_hint" style="display:none;"></div>
              </div>
            </div>
          </div>

          <!-- Description and Duration -->
          <div class="col-md-8">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" placeholder="Describe the issue or service needed"></textarea>
          </div>
          <div class="col-md-4">
            <label class="form-label">Estimated duration (mins)</label>
            <input name="estimated_duration" class="form-control" value="50">
          </div>
        </div>
        <div class="d-flex gap-2 mt-4">
          <button type="button" class="btn btn-light" id="backFromStep3">Back</button>
          <button type="button" class="btn btn-primary ms-auto" id="nextServiceBtn">Next</button>
        </div>

      {% elif intent == 'sales' %}
        <div class="row g-3">
          <!-- Item Details -->
          <div class="col-md-12">
            <label class="form-label">Select Item</label>
            <select name="item_name" id="id_item_name" class="form-select" data-items='{{ item_data_json|escapejs }}'>
              <option value="">Select item</option>
              {% for item in inventory_items %}
                {% if item.brand %}
                  <option value="{{ item.id }}">{{ item.brand.name }} - {{ item.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <input type="hidden" name="brand" id="id_brand">
            <small class="text-muted">Item name and brand will be automatically filled</small>
          </div>

          <!-- Quantity and Tire Type -->
          <div class="col-md-4">
            <label class="form-label">Quantity</label>
            <input name="quantity" class="form-control">
          </div>
          <div class="col-md-8 d-none">
            <input type="hidden" name="tire_type" value="New">
          </div>

          <!-- Tire Service Add-ons -->
          <div class="col-12">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark"><h6 class="mb-0">Tire Service Add-ons</h6></div>
              <div class="card-body">
                <div class="row g-3">
                  {% if sales_addons %}
                    {% for ad in sales_addons %}
                    <div class="col-md-3">
                      <div class="form-check">
                        <input class="form-check-input tire-service-checkbox" type="checkbox" id="cr_ts_{{ forloop.counter }}" name="tire_services" value="{{ ad.name }}" data-minutes="{{ ad.estimated_minutes }}">
                        <label class="form-check-label" for="cr_ts_{{ forloop.counter }}">{{ ad.name }} <small class="text-muted">({{ ad.estimated_minutes }} mins)</small></label>
                      </div>
                    </div>
                    {% endfor %}
                  {% else %}
                    <div class="col-12"><small class="text-muted">No add-ons available</small></div>
                  {% endif %}
                </div>
                <div class="small text-muted mt-2" id="cr_tire_services_total_eta_hint" style="display:none;"></div>
              </div>
            </div>
          </div>

          <!-- Description -->
          <div class="col-12">
            <label class="form-label">Description (optional)</label>
            <textarea name="description" class="form-control" rows="3" placeholder="Additional details about the purchase..."></textarea>
          </div>
        </div>
        <script>
          (function(){
            // Auto-fill item details when item is selected
            try {
              var itemEl = document.getElementById('id_item_name');
              var brandEl = document.getElementById('id_brand');
              if (!itemEl) return;
              var itemsData = {};
              try { itemsData = JSON.parse(itemEl.getAttribute('data-items') || '{}'); } catch(e) { itemsData = {}; }
              itemEl.addEventListener('change', function(){
                var itemData = itemsData[this.value];
                if (itemData && brandEl) { brandEl.value = itemData.brand || ''; }
              });
            } catch(e) { /* noop */ }
          })();
        </script>
        <div class="d-flex gap-2 mt-4">
          <button type="button" class="btn btn-light" id="backFromStep3">Back</button>
          <button type="button" class="btn btn-primary ms-auto" id="nextServiceBtn">Next</button>
        </div>

      {% else %}
        <div class="row">
          <input type="hidden" name="type" value="inquiry">
          <div class="col-md-4">
            <label class="form-label">Priority</label>
            <select name="priority" class="form-select">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="col-md-6 mt-3">
            <label class="form-label">Inquiry type</label>
            <select name="inquiry_type" class="form-select">
              <option value="">Select inquiry type</option>
              <option value="Pricing">Pricing</option>
              <option value="Services">Services</option>
              <option value="Appointment Booking">Appointment Booking</option>
              <option value="General">General</option>
            </select>
          </div>
          <div class="col-md-6 mt-3">
            <label class="form-label">Contact preference</label>
            <select name="contact_preference" class="form-select">
              <option value="">Select preference</option>
              <option value="phone">Phone</option>
              <option value="email">Email</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
          </div>
          <div class="col-12 mt-3">
            <label class="form-label">Questions</label>
            <textarea name="questions" class="form-control" rows="4" placeholder="Please describe your questions or what you'd like to know..."></textarea>
          </div>
        </div>
        <div class="d-flex gap-2 mt-4">
          <button type="button" class="btn btn-light" id="backFromStep3">Back</button>
          <button type="button" class="btn btn-primary ms-auto" id="nextServiceBtn">Next</button>
        </div>
      {% endif %}

    {% else %}
      {# Step 4: Summary and Order creation #}
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">Customer summary</h6>
            </div>
            <div class="card-body">
              <p><strong>Name:</strong> {{ step1.full_name }}</p>
              <p><strong>Phone:</strong> {{ step1.phone }}</p>
              <p><strong>Email:</strong> {{ step1.email }}</p>
              <p><strong>Type:</strong> {{ step1.customer_type }}</p>
              <p><strong>Notes:</strong> {{ step1.notes }}</p>
            </div>
          </div>

          {# Intent-specific summary from Step 3 #}
          {% if intent == 'sales' %}
            <div class="card mb-3">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Purchase Summary</h6>
                <span class="badge bg-warning text-dark">Sales</span>
              </div>
              <div class="card-body">
                <p class="mb-1"><strong>Item:</strong> <span id="summaryItemName">{{ step3.item_name|default:"-" }}</span></p>
                <p class="mb-1"><strong>Brand:</strong> <span id="summaryBrandName">{{ step3.brand|default:"-" }}</span></p>
                <p class="mb-1"><strong>Quantity:</strong> {{ step3.quantity|default:"-" }}</p>
                <p class="mb-1"><strong>Tire type:</strong> {{ step3.tire_type|default:"-" }}</p>
                {% if step3.tire_services %}
                  <p class="mb-0"><strong>Add-ons:</strong> {{ step3.tire_services|join:", " }}</p>
                {% endif %}
              </div>
            </div>

          {% elif intent == 'service' %}
            <div class="card mb-3">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Service Summary</h6>
                <span class="badge bg-success">Service</span>
              </div>
              <div class="card-body">
                {% if step3.service_selection %}
                  <div class="mb-3">
                    <strong>Services:</strong>
                    <ul class="mb-0">
                      {% for s in step3.service_selection %}
                        <li>{{ s }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  <p class="mb-3 text-muted">No services selected.</p>
                {% endif %}

                {% comment %} Show vehicle details if any were entered {% endcomment %}
                <script>
                  // Get vehicle details from step 3 form fields
                  document.addEventListener('DOMContentLoaded', function() {
                    var plateEl = document.getElementById('id_plate_number');
                    var makeEl = document.getElementById('id_make');
                    var modelEl = document.getElementById('id_model');
                    var typeEl = document.getElementById('id_vehicle_type');
                    var plate = plateEl ? plateEl.value : '';
                    var make = makeEl ? makeEl.value : '';
                    var model = modelEl ? modelEl.value : '';
                    var vtype = typeEl ? typeEl.value : '';
                    if (plate || make || model || vtype) {
                      var vehicleInfo = document.createElement('div');
                      vehicleInfo.innerHTML = '<strong>Vehicle:</strong><br>' + (plate ? 'Plate: ' + plate + '<br>' : '') + (make || model ? 'Make/Model: ' + (make + ' ' + model).trim() + '<br>' : '') + (vtype ? 'Type: ' + vtype : '');
                      var serviceBody = document.querySelector('.card-body');
                      if (serviceBody) {
                        serviceBody.appendChild(vehicleInfo);
                      }
                    }
                  });
                </script>
              </div>
            </div>

            {# Vehicle details card for service orders #}
            <div class="card mb-3" id="vehicleServiceSummary">
              <div class="card-header bg-light">
                <h6 class="mb-0">Vehicle Details</h6>
              </div>
              <div class="card-body" id="vehicleDetailsContent">
                {% if step3.plate_number or step3.make or step3.model or step3.vehicle_type %}
                  {% if step3.plate_number %}<p class="mb-1"><strong>Plate Number:</strong> {{ step3.plate_number }}</p>{% endif %}
                  {% if step3.make or step3.model %}<p class="mb-1"><strong>Make/Model:</strong> {{ step3.make }} {{ step3.model }}</p>{% endif %}
                  {% if step3.vehicle_type %}<p class="mb-1"><strong>Type:</strong> {{ step3.vehicle_type }}</p>{% endif %}
                {% else %}
                  <div class="text-muted">No vehicle information provided</div>
                {% endif %}
              </div>
            </div>

          {% elif intent == 'inquiry' %}
            <div class="card mb-3">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Inquiry Summary</h6>
                <span class="badge bg-info text-dark">Inquiry</span>
              </div>
              <div class="card-body">
                <p class="mb-0 text-muted">Proceed to create a inquiry order.</p>
              </div>
            </div>
          {% endif %}

          {# Show vehicle card only for Inquiry; Service vehicle fields are inside the order section #}
          {% if intent == 'inquiry' %}
            <div class="card mb-3" id="vehicleCardStep4">
              <div class="card-header bg-light">
                <h6 class="mb-0">Vehicle (if applicable)</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Plate number</label>
                    <input name="plate_number" id="id_plate_number" class="form-control" placeholder="e.g., T123ABC">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Make</label>
                    <input name="make" id="id_make" class="form-control" placeholder="e.g., Toyota">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Model</label>
                    <input name="model" id="id_model" class="form-control" placeholder="e.g., Corolla">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Vehicle type</label>
                    <select name="vehicle_type" id="id_vehicle_type" class="form-select">
                      <option value="">Select type</option>
                      <option value="sedan">Sedan</option>
                      <option value="suv">SUV</option>
                      <option value="truck">Truck</option>
                      <option value="motorcycle">Motorcycle</option>
                      <option value="bus">Bus</option>
                      <option value="van">Van</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">{% if intent == 'inquiry' %}Order Details{% else %}Order Summary{% endif %}</h6>
            </div>
            <div class="card-body">
              {% with t=order_form.initial.type %}
                {% if intent == 'inquiry' %}
                  <div class="mb-3">
                    <label class="form-label d-block">Order type</label>
                    <span class="badge bg-info text-dark">Inquiries</span>
                    <input type="hidden" name="type" value="inquiry">
                  </div>
                  <ul class="list-unstyled mb-0">
                    <li class="mb-1"><strong>Priority:</strong> {{ step3.priority|default:"-" }}</li>
                    <li class="mb-1"><strong>Vehicle:</strong> {{ step3.vehicle|default:"-" }}</li>
                    <li class="mb-1"><strong>Inquiry type:</strong> {{ step3.inquiry_type|default:"-" }}</li>
                    <li class="mb-1"><strong>Contact preference:</strong> {{ step3.contact_preference|default:"-" }}</li>
                    <li class="mb-1"><strong>Questions:</strong> {{ step3.questions|default:"-" }}</li>
                  </ul>
                  {# Hidden inputs to submit values #}
                  <input type="hidden" name="priority" value="{{ step3.priority }}">
                  <input type="hidden" name="vehicle" value="{{ step3.vehicle }}">
                  <input type="hidden" name="inquiry_type" value="{{ step3.inquiry_type }}">
                  <input type="hidden" name="contact_preference" value="{{ step3.contact_preference }}">
                  <input type="hidden" name="questions" value="{{ step3.questions }}">
                {% else %}
                  <div class="mb-3">
                    <label class="form-label d-block">Order type</label>
                    {% if t == 'sales' %}<span class="badge bg-warning text-dark">Sales</span>{% endif %}
                    {% if t == 'service' %}<span class="badge bg-success">Service</span>{% endif %}
                    {% if t == 'inquiry' %}<span class="badge bg-info text-dark">inquiry</span>{% endif %}
                    <input type="hidden" name="type" value="{{ t }}">
                  </div>
                  {# Read-only summary reflecting data selected in Step 3 #}
                  {% if intent == 'sales' %}
                    <ul class="list-unstyled mb-0">
                      <li class="mb-1"><strong>Item:</strong> {{ step3.item_name|default:"-" }}</li>
                      <li class="mb-1"><strong>Brand:</strong> {{ step3.brand|default:"-" }}</li>
                      <li class="mb-1"><strong>Quantity:</strong> {{ step3.quantity|default:"-" }}</li>
                      <li class="mb-1"><strong>Tire type:</strong> {{ step3.tire_type|default:"-" }}</li>
                      {% if step3.tire_services %}
                        <li class="mb-0"><strong>Add-ons:</strong> {{ step3.tire_services|join:", " }}</li>
                      {% endif %}
                    </ul>
                    {# Hidden inputs to submit values #}
                    <input type="hidden" name="item_name" value="{{ step3.item_name }}">
                    <input type="hidden" name="brand" value="{{ step3.brand }}">
                    <input type="hidden" name="quantity" value="{{ step3.quantity }}">
                    <input type="hidden" name="tire_type" value="{{ step3.tire_type }}">
                    {% if step3.tire_services %}
                      {% for ts in step3.tire_services %}
                        <input type="hidden" name="tire_services" value="{{ ts }}">
                      {% endfor %}
                    {% endif %}
                  {% elif intent == 'service' %}
                    {% if step3.service_selection %}
                      <div class="mb-2">
                        <strong>Services:</strong>
                        <ul class="mb-0">
                          {% for s in step3.service_selection %}
                            <li>{{ s }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% else %}
                      <p class="mb-2 text-muted">No services selected.</p>
                    {% endif %}
                    <div class="mb-2">
                      <strong>Vehicle Details:</strong>
                      <div id="vehicleOrderSummary" class="small text-muted">
                        <div>Plate: <span id="summaryPlate">{{ step3.plate_number|default:"-" }}</span></div>
                        <div>Make/Model: <span id="summaryMakeModel">{% if step3.make or step3.model %}{{ step3.make }} {{ step3.model }}{% else %}-{% endif %}</span></div>
                        <div>Type: <span id="summaryType">{{ step3.vehicle_type|default:"-" }}</span></div>
                      </div>
                    </div>
                    {# Hidden inputs to submit values #}
                    {% if step3.service_selection %}
                      {% for s in step3.service_selection %}
                        <input type="hidden" name="service_selection" value="{{ s }}">
                      {% endfor %}
                    {% endif %}
                    <input type="hidden" name="plate_number" value="{{ step3.plate_number }}">
                    <input type="hidden" name="make" value="{{ step3.make }}">
                    <input type="hidden" name="model" value="{{ step3.model }}">
                    <input type="hidden" name="vehicle_type" value="{{ step3.vehicle_type }}">
                    <input type="hidden" name="description" value="{{ step3.description }}">
                    <input type="hidden" name="estimated_duration" value="{{ step3.estimated_duration }}">
                  {% endif %}
                  <hr>
                  <p class="mb-0 text-muted">Review the summary on the left. No additional selections are required.</p>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="button" class="btn btn-light" id="backFromStep4">Back</button>
        <button type="submit" class="btn btn-success ms-auto">Create Customer & Order</button>
      </div>
    {% endif %}
  </div>
</form>

<script>
// Inline small helpers to maintain progressive enhancement when JS file not loaded
document.addEventListener('DOMContentLoaded', function(){
  // Toggle conditional Customer fields in Step 1
  var customerType = document.getElementById('id_customer_type');
  function toggleCustomerFields(){
    if(!customerType) return;
    var val = customerType.value;
    var ps = document.getElementById('personal-subtype-field');
    var org = document.getElementById('organization-field');
    var tax = document.getElementById('tax-field');
    
    // Hide all fields first
    if(ps) ps.style.display = 'none';
    if(org) org.style.display = 'none';
    if(tax) tax.style.display = 'none';
    
    // Show relevant fields based on selection
    if(val === 'personal' && ps) {
      ps.style.display = 'block';
    } else if(['company','government','ngo'].indexOf(val) !== -1) {
      if(org) org.style.display = 'block';
      if(tax) tax.style.display = 'block';
    }
  }
  
  if(customerType){
    customerType.addEventListener('change', toggleCustomerFields);
    toggleCustomerFields();
  }

  // Wire quick save button if present
  var saveBtn = document.getElementById('saveCustomerBtn');
  if(saveBtn){
    saveBtn.addEventListener('click', function(e){
      e.preventDefault();
      // Always use AJAX handler when available
      var saveOnly = document.getElementById('saveOnly');
      if(saveOnly) saveOnly.value = '1';
      var form = document.getElementById('customerRegistrationForm');
      // Submit normally to allow server-side redirect when JS not available
      if(window.__CUSTOMER_REG_AJAX){
        // Use AJAX submission
        if(typeof ajaxPostForm !== 'undefined'){
          ajaxPostForm(form, function(data){
            if(data.redirect_url){ 
              window.location.href = data.redirect_url; 
            } else if(data.success && data.message){ 
              alert(data.message); 
            }
          }, function(err){ 
            alert('Error saving customer: ' + err); 
          });
        }
      } else {
        // Fallback to normal form submission
        form.submit();
      }
    });
  }

  // Step 2: Intent selection helper (service/sales/inquiry)
  window.selectIntent = function(val){
    try {
      var intentInput = document.getElementById('registrationIntent');
      if (intentInput) intentInput.value = val;
      var radios = document.querySelectorAll('input[name="intent"]');
      radios.forEach(function(r){ r.checked = (r.value === val); });
      // Visual selection for cards
      document.querySelectorAll('.intent-card').forEach(function(card){
        card.classList.remove('border-primary');
      });
      var activeCard = document.querySelector('.intent-card input[value="'+val+'"]');
      if (activeCard && activeCard.closest('.intent-card')) {
        activeCard.closest('.intent-card').classList.add('border-primary');
      }
    } catch(e) { /* noop */ }
  };

  // Step 3: Toggle service offer checkboxes (inputs are hidden) and update ETA
  try {
    // Update service ETA for service selections
    function updateCrServiceEta(){
      var total = 0;
      document.querySelectorAll('input[type="checkbox"][name="service_selection"]:checked').forEach(function(cb){
        var m = parseInt(cb.getAttribute('data-minutes') || '0', 10);
        if(!isNaN(m)) total += m;
      });
      var etaInput = document.querySelector('input[name="estimated_duration"]');
      var hint = document.getElementById('cr_total_eta_hint');
      if(etaInput){
        if(total > 0){ etaInput.value = String(total); }
        if(hint){
          if(total > 0){ hint.style.display=''; hint.textContent = 'Estimated total time: ' + total + ' mins'; }
          else { hint.style.display='none'; hint.textContent=''; }
        }
      }
      // Also update the combined total if we're in sales section
      updateCrCombinedEta();
    }
    
    // Update tire services ETA for sales add-ons
    function updateCrTireServicesEta(){
      var total = 0;
      document.querySelectorAll('input[type="checkbox"][name="tire_services"]:checked').forEach(function(cb){
        var m = parseInt(cb.getAttribute('data-minutes') || '0', 10);
        if(!isNaN(m)) total += m;
      });
      var hint = document.getElementById('cr_tire_services_total_eta_hint');
      if(hint){
        if(total > 0){
          hint.style.display = '';
          hint.textContent = 'Estimated total time: ' + total + ' mins';
        } else {
          hint.style.display = 'none';
          hint.textContent = '';
        }
      }
      // Also update the combined total if we're in sales section
      updateCrCombinedEta();
    }
    
    // Update combined ETA for both service and tire services
    function updateCrCombinedEta(){
      var serviceTotal = 0;
      var tireServiceTotal = 0;
      
      // Calculate service total
      document.querySelectorAll('input[type="checkbox"][name="service_selection"]:checked').forEach(function(cb){
        var m = parseInt(cb.getAttribute('data-minutes') || '0', 10);
        if(!isNaN(m)) serviceTotal += m;
      });
      
      // Calculate tire services total
      document.querySelectorAll('input[type="checkbox"][name="tire_services"]:checked').forEach(function(cb){
        var m = parseInt(cb.getAttribute('data-minutes') || '0', 10);
        if(!isNaN(m)) tireServiceTotal += m;
      });
      
      var combinedTotal = serviceTotal + tireServiceTotal;
      var etaInput = document.querySelector('input[name="estimated_duration"]');
      
      if(etaInput){
        if(combinedTotal > 0){ 
          etaInput.value = String(combinedTotal); 
        }
      }
    }
    
    // Service offer card click handlers
    document.querySelectorAll('.service-offer').forEach(function(lbl){
      lbl.addEventListener('click', function(e){
        var cb = lbl.querySelector('input[type="checkbox"][name="service_selection"]');
        if (!cb) return;
        cb.checked = !cb.checked;
        lbl.classList.toggle('border-primary', cb.checked);
        lbl.classList.toggle('bg-light', cb.checked);
        updateCrServiceEta();
      });
    });
    
    // Tire service checkbox change handlers
    document.querySelectorAll('input[type="checkbox"][name="tire_services"]').forEach(function(cb){
      cb.addEventListener('change', updateCrTireServicesEta);
    });
    
    // Initialize ETAs
    updateCrServiceEta();
    updateCrTireServicesEta();
  } catch(e) { /* noop */ }

  // Update item/brand summary in step 4
  function updateItemSummary() {
    try {
      var itemEl = document.getElementById('id_item_name');
      var brandEl = document.getElementById('id_brand');
      if (itemEl && brandEl) {
        var itemsData = {};
        try {
          itemsData = JSON.parse(itemEl.getAttribute('data-items') || '{}');
        } catch(e) {
          itemsData = {};
        }
        var itemData = itemsData[itemEl.value];
        var summaryItemName = document.getElementById('summaryItemName');
        var summaryBrandName = document.getElementById('summaryBrandName');
        if (summaryItemName) summaryItemName.textContent = itemData ? itemData.name : '-';
        if (summaryBrandName) summaryBrandName.textContent = itemData ? itemData.brand : '-';
        // Update hidden brand field
        if (brandEl && itemData) {
          brandEl.value = itemData.brand || '';
        }
      }
    } catch (e) { /* noop */ }
  }

  // Update vehicle summary in step 4 when vehicle fields change
  function updateVehicleSummary() {
    try {
      var plateEl = document.getElementById('id_plate_number');
      var makeEl = document.getElementById('id_make');
      var modelEl = document.getElementById('id_model');
      var typeEl = document.getElementById('id_vehicle_type');
      var plate = plateEl ? plateEl.value.trim() : '';
      var make = makeEl ? makeEl.value.trim() : '';
      var model = modelEl ? modelEl.value.trim() : '';
      var vtype = typeEl ? typeEl.value : '';
      // If no form fields, try to get from stored data
      if (!plate && !make && !model && !vtype) {
        try {
          var stored = sessionStorage.getItem('customerRegVehicleData');
          if (stored) {
            var vehicleData = JSON.parse(stored);
            plate = vehicleData.plate_number || '';
            make = vehicleData.make || '';
            model = vehicleData.model || '';
            vtype = vehicleData.vehicle_type || '';
          }
        } catch(e) {}
      }
      // Update summary elements if they exist
      var summaryPlate = document.getElementById('summaryPlate');
      var summaryMakeModel = document.getElementById('summaryMakeModel');
      var summaryType = document.getElementById('summaryType');
      if (summaryPlate && summaryPlate.textContent === '-') summaryPlate.textContent = plate || '-';
      if (summaryMakeModel && summaryMakeModel.textContent === '-') summaryMakeModel.textContent = (make + ' ' + model).trim() || '-';
      if (summaryType && summaryType.textContent === '-') summaryType.textContent = vtype || '-';
      // Update vehicle details content if it shows default message
      var vehicleContent = document.getElementById('vehicleDetailsContent');
      if (vehicleContent && vehicleContent.textContent.includes('No vehicle information provided')) {
        if (plate || make || model || vtype) {
          var html = '';
          if (plate) html += '<p class="mb-1"><strong>Plate Number:</strong> ' + plate + '</p>';
          if (make || model) html += '<p class="mb-1"><strong>Make/Model:</strong> ' + (make + ' ' + model).trim() + '</p>';
          if (vtype) html += '<p class="mb-1"><strong>Type:</strong> ' + vtype + '</p>';
          if (html) vehicleContent.innerHTML = html;
        }
      }
    } catch (e) { /* noop */ }
  }

  // Add event listeners to vehicle fields
  var vehicleFields = ['id_plate_number', 'id_make', 'id_model', 'id_vehicle_type'];
  for (var i = 0; i < vehicleFields.length; i++) {
    var id = vehicleFields[i];
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', updateVehicleSummary);
      el.addEventListener('change', updateVehicleSummary);
    }
  }

  // Add event listener for item selection
  var itemEl = document.getElementById('id_item_name');
  if (itemEl) {
    itemEl.addEventListener('change', updateItemSummary);
  }

  // Initial updates
  updateVehicleSummary();
  updateItemSummary();
});
</script>